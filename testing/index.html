<!doctype html><html><head><title>Testing :: Lucid</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=revised content="2022-11-15T10:19:24 UTC"><meta name=description content><title>Testing :: Lucid</title><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css integrity=sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css><script src=https://code.jquery.com/jquery-3.5.1.min.js></script>
<link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel=stylesheet><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/layout.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/css/style.main.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/css/style.menu.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/notice.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/tabs.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/panel.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/columns.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/children.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/attachments.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/alert.css><link rel=stylesheet type=text/css href=/css/docport.css><script src=/js/docport.js></script>
<script type=text/javascript>var baseurl="https://docs.lucidarch.dev"</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-96232175-1","auto"),ga("send","pageview"))</script><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=/css/syntax.css><link rel=apple-touch-icon sizes=180x180 href=/icon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/icon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/icon/favicon-16x16.png><link rel=manifest href=/icon/site.webmanifest><script async defer src=https://buttons.github.io/buttons.js></script></head><body data-url=/testing/ class=hideheader><style type=text/css>#debug{display:-webkit-box;display:-ms-flexbox;display:flex;line-height:3.5rem;margin-bottom:.35rem;padding:0 2rem;position:fixed;left:0;right:0;top:0;top:0;min-height:150px;background-color:#fff;border:3px solid red;z-index:10000;word-wrap:all;overflow:auto}</style><article><aside><div class=search><div class=searchbox><input data-search-input id=search-by type=text placeholder="Type to search..."></div><script type=text/javascript src=/vendor/lunr/lunr.min.js></script>
<script type=text/javascript src=/vendor/auto-complete/auto-complete.js></script>
<link href=/vendor/auto-complete/auto-complete.css rel=stylesheet><script type=text/javascript>var baseurl="https://docs.lucidarch.dev"</script><script type=text/javascript src=/js/search.js></script></div><div style=margin-top:30px><a href=/concept style=display:flex;justify-content:left;align-items:center><img src=/icon/logo.png width=250 style=margin-left:10px></a></div><div id=close_menu><a href=javascript:void(0); style=font-size:15px onclick='$("article > aside").toggleClass("responsive")'><i class="fa fa-lg fa-times"></i></a></div><ul class=menu><li data-nav-id=https://docs.lucidarch.dev/concept/ class="dd-item
item_level_$level"><a href=/concept/>Concept</a></li><li data-nav-id=https://docs.lucidarch.dev/philosophy/ class="dd-item
item_level_$level"><a href=/philosophy/>Philosophy</a></li><li data-nav-id=https://docs.lucidarch.dev/principles/ class="dd-item
item_level_$level"><a href=/principles/>Principles</a></li><hr><li data-nav-id=https://docs.lucidarch.dev/installation/ class="dd-item
item_level_$level"><a href=/installation/>Installation</a></li><li data-nav-id=https://docs.lucidarch.dev/upgrade-guide/ class="dd-item alwaysopen
item_level_$level"><a href=/upgrade-guide/>Upgrade Guide</a></li><li data-nav-id=https://docs.lucidarch.dev/contribution-guide/ class="dd-item
item_level_$level"><a href=/contribution-guide/>Contribution Guide</a></li><hr><li data-nav-id=https://docs.lucidarch.dev/getting-started/ class="dd-item alwaysopen
item_level_$level"><a href=/getting-started/>Getting Started</a></li><li data-nav-id=https://docs.lucidarch.dev/micro-vs-monolith/ class="dd-item
item_level_$level"><a href=/micro-vs-monolith/>Micro â€¢ Monolith</a></li><hr><li data-nav-id=https://docs.lucidarch.dev/routing/ class="dd-item
item_level_$level"><a href=/routing/>Routing</a></li><li data-nav-id=https://docs.lucidarch.dev/controllers/ class="dd-item
item_level_$level"><a href=/controllers/>Controllers</a></li><hr><li data-nav-id=https://docs.lucidarch.dev/features/ class="dd-item
item_level_$level"><a href=/features/>Features</a></li><li data-nav-id=https://docs.lucidarch.dev/jobs/ class="dd-item
item_level_$level"><a href=/jobs/>Jobs</a></li><li data-nav-id=https://docs.lucidarch.dev/operations/ class="dd-item
item_level_$level"><a href=/operations/>Operations</a></li><li data-nav-id=https://docs.lucidarch.dev/services/ class="dd-item
item_level_$level"><a href=/services/>Services</a></li><li data-nav-id=https://docs.lucidarch.dev/domains/ class="dd-item
item_level_$level"><a href=/domains/>Domains</a></li><hr><li data-nav-id=https://docs.lucidarch.dev/testing/ class="dd-item active
item_level_$level"><a href=/testing/>Testing</a></li><li data-nav-id=https://docs.lucidarch.dev/database/ class="dd-item
item_level_$level"><a href=/database/>Database</a></li><li data-nav-id=https://docs.lucidarch.dev/validation/ class="dd-item
item_level_$level"><a href=/validation/>Validation</a></li><hr><li data-nav-id=https://docs.lucidarch.dev/cli/ class="dd-item
item_level_$level"><a href=/cli/>CLI Reference</a></li></ul></aside><section class=page><nav id=ariane aria-label=breadcrumb><ol class=ariane><li><a class=text-link href=https://docs.lucidarch.dev>Home</a></li><li class=active>Testing</li></ol></nav><h1>Testing</h1><div class=jump-to-section><span onclick='$h=$(this),$h.next("nav").slideToggle(100,function(){$h.children("i").attr("class",function(){return $h.next("nav").is(":visible")?"fas fa-chevron-down":"fas fa-chevron-right"})})'><span class="fas fa-align-right"></span>
Jump to Section
<i class="fas fa-chevron-right"></i></span><nav id=TableOfContents><ul><li><a href=#mocking-units>Mocking Units</a></li><li><a href=#expectation-types>Expectation Types</a><ul><li><a href=#shouldbedispatched>shouldBeDispatched</a></li><li><a href=#shouldreturn>shouldReturn</a></li><li><a href=#shouldthrow>shouldThrow</a></li><li><a href=#shouldreturnbool>shouldReturn[Bool]</a></li></ul></li><li><a href=#testing-features>Testing Features</a></li><li><a href=#about-testing-and-databases>About Testing and Databases</a></li></ul></nav></div><div class=content><h2 ref=mocking-units>Mocking Units</h2><a class=anchor id=mocking-units></a><p>Lucid takes testing very seriously, thus it tries to make it extremely simple to simulate use cases with very little coding.</p><p>Every Lucid unit in the stack can be mocked by calling <code>mock([$args])->should*()</code> to make it easier to be replaced with a mock version of itself.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>GetUserByIDJob</span><span class=o>::</span><span class=na>mock</span><span class=p>([</span><span class=s1>&#39;id&#39;</span> <span class=o>=&gt;</span> <span class=nv>$id</span><span class=p>])</span><span class=o>-&gt;</span><span class=na>shouldReturn</span><span class=p>(</span><span class=nv>$user</span><span class=p>);</span>
</span></span></code></pre></div><p>This will replace any call to <code>GetUserByIDJob</code> with the corresponding parameters with this instance and return the given <code>$user</code>,
as long as the passed arguments matches the unit&rsquo;s constructor signature, as well as the calling method</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=k>new</span> <span class=nx>GetUserByIDJob</span><span class=p>(</span><span class=nx>id</span><span class=o>:</span> <span class=nv>$id</span><span class=p>));</span>
</span></span></code></pre></div><p>otherwise an exception will be thrown for not finding a perfect match. For example, the following will certainly not pass the tests:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=k>new</span> <span class=nx>GetUserByIDJob</span><span class=p>(</span><span class=nx>notid</span><span class=o>:</span> <span class=nv>$id</span><span class=p>));</span>
</span></span></code></pre></div><p>The purpose of testing units is to make sure that whoever calls them is passing the right parameters
and will be aware of their signature changes, in which case tests shall fail.</p><p>For example, if <code>GetUserByIDJob</code> were to change signature and add another parameter, which ever test uses its mock shall fail:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>class</span> <span class=nc>GetUserByIDJob</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$id</span><span class=p>,</span> <span class=nv>$isFlat</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Now our previous mock will certainly cause a failure since it&rsquo;s not matching the constructor args, and thus achieve a reliable suite of tests.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>GetUserByIDJob</span><span class=o>::</span><span class=na>mock</span><span class=p>([</span><span class=s1>&#39;id&#39;</span> <span class=o>=&gt;</span> <span class=nv>$id</span><span class=p>])</span><span class=o>-&gt;</span><span class=na>shouldReturn</span><span class=p>(</span><span class=nv>$user</span><span class=p>);</span> <span class=c1>// fail!
</span></span></span></code></pre></div><h2 ref=expectation-types>Expectation Types</h2><a class=anchor id=expectation-types></a><p>Creating a mock by calling <code>mock()</code> on a unit alone wouldn&rsquo;t suffice, there needs to be an expectation in order for the mock to be registered.</p><p>Since testing and mocking is all about simulating expectations, here are the methods you can use to set them.</p><h3 ref=shouldbedispatched>shouldBeDispatched</h3><a class=anchor id=shouldbedispatched></a><div class=card><div class=card-body><p class=card-text><h4 ref=shouldbedispatched-void><code>shouldBeDispatched(): void</code></h4><a class=anchor id=shouldbedispatched-void></a><p>This method is used when we expect the unit to be dispatched but we&rsquo;re not waiting for any output.</p><p><strong>Example</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=k>new</span> <span class=nx>InviteMemberJob</span><span class=p>(</span><span class=nx>memberId</span><span class=o>:</span> <span class=nv>$memberId</span><span class=p>));</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>InviteMemberJob</span><span class=o>::</span><span class=na>mock</span><span class=p>([</span><span class=s1>&#39;memberId&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;some-member&#39;</span><span class=p>])</span><span class=o>-&gt;</span><span class=na>shouldBeDispatched</span><span class=p>();</span>
</span></span></code></pre></div></p></div></div><h3 ref=shouldreturn>shouldReturn</h3><a class=anchor id=shouldreturn></a><div class=card><div class=card-body><p class=card-text><h4 ref=shouldreturnvalue-mixed><code>shouldReturn($value): mixed</code></h4><a class=anchor id=shouldreturnvalue-mixed></a><p>This method is used to return any value that will be expected upon the unit&rsquo;s execution.</p><p><strong>Example</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$repos</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=k>new</span> <span class=nx>FetchGitHubReposOperation</span><span class=p>(</span><span class=nx>username</span><span class=o>:</span> <span class=nv>$username</span><span class=p>));</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$repos</span> <span class=o>=</span> <span class=nx>collect</span><span class=p>(</span><span class=nx>GitHubRepository</span><span class=o>::</span><span class=na>factory</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>make</span><span class=p>(</span><span class=mi>5</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>FetchGitHubReposOperation</span><span class=o>::</span><span class=na>mock</span><span class=p>([</span><span class=s1>&#39;username&#39;</span> <span class=o>=&gt;</span> <span class=nv>$username</span><span class=p>])</span><span class=o>-&gt;</span><span class=na>shouldReturn</span><span class=p>(</span><span class=nv>$repos</span><span class=p>);</span>
</span></span></code></pre></div></p></div></div><h3 ref=shouldthrow>shouldThrow</h3><a class=anchor id=shouldthrow></a><div class=card><div class=card-body><p class=card-text><p><strong><code>shouldThrow($exception, $message = '', $code = 0, Exception $previous = null): void</code></strong></p><p>This method simulates a unit throwing an exception.</p><p><strong>Example</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=k>new</span> <span class=nx>AddPostJob</span><span class=p>(</span><span class=nx>title</span><span class=o>:</span> <span class=nv>$title</span><span class=p>,</span> <span class=nx>content</span><span class=o>:</span> <span class=nv>$content</span><span class=p>));</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>AddPostJob</span><span class=o>::</span><span class=na>mock</span><span class=p>([</span><span class=s1>&#39;title&#39;</span> <span class=o>=&gt;</span> <span class=nv>$title</span><span class=p>,</span> <span class=s1>&#39;content&#39;</span> <span class=o>=&gt;</span> <span class=nv>$content</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=o>-&gt;</span><span class=na>shouldThrow</span><span class=p>(</span><span class=k>new</span> <span class=nx>NotLoggedInException</span><span class=p>(),</span> <span class=s1>&#39;you must be logged in to add a post&#39;</span><span class=p>,</span> <span class=mi>401</span><span class=p>))</span>
</span></span></code></pre></div></p></div></div><h3 ref=shouldreturnbool>shouldReturn[Bool]</h3><a class=anchor id=shouldreturnbool></a><div class=card><div class=card-body><p class=card-text><h4 ref=shouldreturntrue-true--shouldreturnfalse-false><code>shouldReturnTrue(): true</code> & <code>shouldReturnFalse(): false</code></h4><a class=anchor id=shouldreturntrue-true--shouldreturnfalse-false></a><p>The use of these methods is as obvious, to return the corresponding boolean.</p><p><strong>Example</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$authorized</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=k>new</span> <span class=nx>CheckUserAuthorizationJob</span><span class=p>(</span><span class=nx>user</span><span class=o>:</span> <span class=nv>$user</span><span class=p>));</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>CheckUserAuthorizationJob</span><span class=o>::</span><span class=na>mock</span><span class=p>([</span><span class=s1>&#39;user&#39;</span> <span class=o>=&gt;</span> <span class=nv>$user</span><span class=p>])</span><span class=o>-&gt;</span><span class=na>shouldReturnTrue</span><span class=p>();</span> <span class=c1>// authorized
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>CheckUserAuthorizationJob</span><span class=o>::</span><span class=na>mock</span><span class=p>([</span><span class=s1>&#39;user&#39;</span> <span class=o>=&gt;</span> <span class=nv>$user</span><span class=p>])</span><span class=o>-&gt;</span><span class=na>shouldReturnFalse</span><span class=p>();</span> <span class=c1>// not authorized
</span></span></span></code></pre></div></p></div></div><h2 ref=testing-features>Testing Features</h2><a class=anchor id=testing-features></a><p>Upon generating a feature, a test file would&rsquo;ve already been generated with it in the same name.
Feature tests reside at <code>tests/Feature/*</code> in compliance with Laravel&rsquo;s directory structure.</p><p>When testing features we&rsquo;re interested in the sequence of executions that happen in the feature&rsquo;s <code>handle</code> method,
and in making sure that the right units (jobs and operations) are being called with the correct arguments.
To achieve that we&rsquo;d have to mock some calls and execute the ones we can.</p><p>Lucid makes it extremely easy to mock and set expectations to replace the units you need.</p><p>Consider a feature to create a channel in a chat application; the following steps need to be taken in order to successfully create one:</p><ol><li>Fetch the member&rsquo;s object by ID</li><li>Make sure the user is authorized to create a channel</li><li>Create channel</li><li>Add the user to the channel</li><li>Invite members to join the channel as well</li></ol><p>Here&rsquo;s how that might look like in code (simplified):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>class</span> <span class=nc>CreateChannelFeature</span> <span class=k>extends</span> <span class=nx>Feature</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>(</span><span class=nx>CreateChannelRequest</span> <span class=nv>$request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$member</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=k>new</span> <span class=nx>GetMemberByIdJob</span><span class=p>(</span><span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nv>$authorized</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=k>new</span> <span class=nx>AuthorizeMemberActionJob</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>action</span><span class=o>:</span> <span class=nx>Action</span><span class=o>::</span><span class=na>CREATE_CHANNEL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nv>$authorized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=nx>UnauthorizedActionException</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nv>$channel</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=k>new</span> <span class=nx>CreateChannelJob</span><span class=p>(</span><span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;title&#39;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=k>new</span> <span class=nx>AddMemberToChannelJob</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>member</span><span class=o>:</span> <span class=nv>$member</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>channel</span><span class=o>:</span> <span class=nv>$channel</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=k>new</span> <span class=nx>InviteMembersToChannelOperation</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>channel</span><span class=o>:</span> <span class=nv>$channel</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>members</span><span class=o>:</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;invited&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>When testing that feature class, we will use Lucid&rsquo;s unit mocking techniques to turn some knobs around and simulate our test cases.
Here are a few examples:</p><p><strong>Test Unauthorized Member</strong></p><p>To simulate an unauthorized user we&rsquo;d need to mock <code>AuthorizeMemberActionJob</code> and return <code>false</code> so that it throws the corresponding exception.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>public</span> <span class=k>function</span> <span class=nf>test_create_organization_unauthorized_member</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$member</span> <span class=o>=</span> <span class=nx>Member</span><span class=o>::</span><span class=na>factory</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>make</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>AuthorizeMemberActionJob</span><span class=o>::</span><span class=na>mock</span><span class=p>([</span><span class=s1>&#39;action&#39;</span> <span class=o>=&gt;</span> <span class=nx>Action</span><span class=o>::</span><span class=na>CREATE_CHANNEL</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>shouldReturnFalse</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>expectException</span><span class=p>(</span><span class=nx>UnauthorizedActionException</span><span class=o>::</span><span class=na>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>postJson</span><span class=p>(</span><span class=s1>&#39;/channels&#39;</span><span class=p>,</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;id&#39;</span> <span class=o>=&gt;</span> <span class=nv>$member</span><span class=o>-&gt;</span><span class=na>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;title&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;ping-channel&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;invited&#39;</span> <span class=o>=&gt;</span> <span class=p>[</span><span class=s1>&#39;member-id-1&#39;</span><span class=p>,</span> <span class=s1>&#39;member-id-2&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Simulate an Invitation Error</strong></p><p>To see how our code will behave when an issue occurs as we invite other members, let&rsquo;s cause it to happen.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>public</span> <span class=k>function</span> <span class=nf>test_create_organization_invitation_error</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$member</span> <span class=o>=</span> <span class=nx>Member</span><span class=o>::</span><span class=na>factory</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>make</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nv>$channel</span> <span class=o>=</span> <span class=nx>Channel</span><span class=o>::</span><span class=na>factory</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>make</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>AuthorizeMemberActionJob</span><span class=o>::</span><span class=na>mock</span><span class=p>([</span><span class=s1>&#39;action&#39;</span> <span class=o>=&gt;</span> <span class=nx>Action</span><span class=o>::</span><span class=na>CREATE_CHANNEL</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>shouldReturnTrue</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// we will need this to be pass it to the following operation
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>CreateChannelJob</span><span class=o>::</span><span class=na>mock</span><span class=p>([</span><span class=s1>&#39;title&#39;</span> <span class=o>=&gt;</span> <span class=nv>$channel</span><span class=o>-&gt;</span><span class=na>title</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>shouldReturn</span><span class=p>(</span><span class=nv>$channel</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>InviteMembersToChannelOperation</span><span class=o>::</span><span class=na>mock</span><span class=p>([</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;channel&#39;</span> <span class=o>=&gt;</span> <span class=nv>$channel</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;members&#39;</span> <span class=o>=&gt;</span> <span class=p>[</span><span class=s1>&#39;member-id-1&#39;</span><span class=p>,</span> <span class=s1>&#39;member-id-2&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>])</span><span class=o>-&gt;</span><span class=na>shouldThrow</span><span class=p>(</span><span class=k>new</span> <span class=nx>DatabaseConnectionException</span><span class=p>(),</span> <span class=s1>&#39;could not connect to database&#39;</span><span class=p>,</span> <span class=mi>500</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>postJson</span><span class=p>(</span><span class=s1>&#39;/channels&#39;</span><span class=p>,</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;id&#39;</span> <span class=o>=&gt;</span> <span class=nv>$member</span><span class=o>-&gt;</span><span class=na>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;title&#39;</span> <span class=o>=&gt;</span> <span class=nv>$channel</span><span class=o>-&gt;</span><span class=na>title</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;invited&#39;</span> <span class=o>=&gt;</span> <span class=p>[</span><span class=s1>&#39;member-id-1&#39;</span><span class=p>,</span> <span class=s1>&#39;member-id-2&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 ref=about-testing-and-databases>About Testing and Databases</h2><a class=anchor id=about-testing-and-databases></a><p>It is recommended that Feature tests cover the entire set of functionalities, including storage,
however unit tests that cover Jobs and Operations should be left for preference, though make sure you are consistent across your codebase.</p><p>Nevertheless, sometimes we may choose to not hit the DB. Mocking can help with that since it will replace
the unit (job/operation) with its mock so when executing its code won&rsquo;t run. It is extremely important, however, to ensure that the job
being mocked has tests of its own, extensively, otherwise we&rsquo;ll be leaving loose ends and may face unanticipated outcomes.</p></div><div class=chevrons><a class=next href=/database/ title=Database style=margin-right:0><div><p>Next page</p><label>Database</label></div><i class="fas fa-arrow-right" style=font-size:1.7em></i></a></div></section><section class=right-menu><div class=TableOfContents><label><i class="fas fa-align-right"></i>&nbsp;&nbsp;What's on this page</label><nav><ul><li><a href=/testing/>Testing</a></li></ul></nav><nav id=TableOfContents><ul><li><a href=#mocking-units>Mocking Units</a></li><li><a href=#expectation-types>Expectation Types</a><ul><li><a href=#shouldbedispatched>shouldBeDispatched</a></li><li><a href=#shouldreturn>shouldReturn</a></li><li><a href=#shouldthrow>shouldThrow</a></li><li><a href=#shouldreturnbool>shouldReturn[Bool]</a></li></ul></li><li><a href=#testing-features>Testing Features</a></li><li><a href=#about-testing-and-databases>About Testing and Databases</a></li></ul></nav></div><div class=Actions><nav><ul><li><i class='fas fa-calendar'></i>
Last update on 15 November 2022</li><li title><i class='fas fa-user'></i>
Last update by Abed Halawi</li></ul></nav></div></section></article><footer><div class=columns><div class=column><div style=font-family:Raleway!important><h3 style=color:#fdfdfd!important>lucid architecture</h3>for a scalable future software</div></div><div class=column><div style=display:flex;justify-content:flex-end;align-items:center><div style=align-items:center;display:flex><a href=https://lucidarch.dev target=_blank><img src=/icon/lucid-coloured.png alt="Lucid website link" width=28px style=margin-top:4px></a>
<a href=https://github.com/lucidarch target=_blank style=margin-left:10px><i class="fab fa-github fa-lg"></i></a>
<a href=https://lucid-slack.herokuapp.com target=_blank style=margin-left:10px><i class="fab fa-slack fa-lg"></i></a>
<a href=https://www.reddit.com/r/lucidarch target=_blank style=margin-left:10px><i class="fab fa-reddit-alien fa-lg"></i></a></div><div style=margin-left:50px;margin-top:6px><a class=github-button href=https://github.com/sponsors/lucidarch data-icon=octicon-heart aria-label="Sponsor @lucidarch on GitHub">Sponsor</a>
<a class=github-button href=https://github.com/lucidarch/lucid data-icon=octicon-star data-show-count=true aria-label="Star lucidarch/lucid on GitHub">Star</a></div></div></div></div></footer></body></html>